<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Year In Review | Automatic Labs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta property="og:title" content="Driving Year in Review | Automatic"/>
    <meta property="og:image" content="https://dashboard.automatic.com/labs/year-in-review/img/2015-year-in-review-banner.png"/>
    <meta property="og:site_name" content="Automatic"/>
    <meta property="og:description" content="What % of Earth’s circumference did I drive last year? How much did I spend on fuel, and what % of my weekday hours did I spend driving?"/>

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@automatic">
    <meta name="twitter:title" content="Driving Year in Review | Automatic">
    <meta name="twitter:description" content="What % of Earth’s circumference did I drive last year? How much did I spend on fuel, and what % of my weekday hours did I spend driving?">
    <meta name="twitter:image" content="https://dashboard.automatic.com/labs/year-in-review/img/2015-year-in-review-banner.png">

    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="https://api.tiles.mapbox.com/mapbox.js/v2.2.3/mapbox.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/metrics-graphics/2.7.0/metricsgraphics.min.css" rel="stylesheet" />
    <link href="../common/css/style.css" rel="stylesheet" />
    <link href="css/year-in-review.css" rel="stylesheet" />
  </head>
  <body>
    <a href="/#/labs" class="automatic-labs top dark" title="Back to Automatic Labs Home">Labs</a>
    <a class="btn-logout" href="/#logout">Log out</a>
    <div class="loading">
      <div class="title">Loading...</div>
      <div class="progress"></div>
    </div>
    <div class="wrapper">
      <div class="year-in-review-header">
        <div class="year-in-review-menu">
          <a href="#durationSection">Duration
          </a><a href="#distanceSection">Distance
          </a><a href="#longestTripSection">Longest Trip
          </a><a href="#statesSection">States Visited
          </a><a href="#durationWeekday">Duration Weekday
          </a><a href="#co2Section">CO2
          </a><a href="#mpgSection">MPG
          </a>
        </div>
        <h1>A Year At the Wheel</h1>
        <div class="alert-demo">This is sample data from a demo account. <a class="login-link" href="#">Log in</a> to view your Automatic driving history.</div>
        <div class="intro-text">
          Welcome to your driving data Year in Review.<br>
          We hope you'll find this summary interesting and insightful.<br>
          Thanks for using Automatic. Drive on!</br>
        </div>
        <div class="share-intro-text">
          Generate your very own Year in Review report of your driving data.<br>
          Just <a class="login-link" href="#">log in with your Automatic account</a> to view and share.<br>
          Not an Automatic user? <a href="https://automatic.com">LEARN MORE</a>
        </div>
        <hr class="short-bar">
      </div>
    </div>

    <div id="results">
      <div class="wrapper">
        <div class="user-info">
          <div class="username"></div>
          <div class="first-trip-date"></div>
          <div class="year-control">
            <div class="year-control-wrapper">
              <select id="year"></select>
            </div>
          </div>
        </div>
      </div>

      <div class="container duration-container" id="durationSection">
        <div class="container-half">
          <div id="duration" class="large-number"></div>
          <div class="large-number-label">days behind the wheel</div>
          <div class="large-number-fact"><strong><span id="durationPercent"></span></strong> of your life</div>
        </div>
        <div class="container-half container-graph">
          <div id="distanceGraph" class="graph"></div>
        </div>
        <div class="container-icon"></div>
      </div>
      <div class="container distance-container" id="distanceSection">
        <div class="container-whole">
          <div id="distance" class="large-number"></div>
          <div class="large-number-label">miles driven</div>
          <div class="large-number-fact"><strong><span id="distancePercentEarth"></span></strong> of Earth's circumference</div>
          <div class="container-icon"></div>
        </div>
      </div>
      <div class="container longest-trip-container" id="longestTripSection">
        <div class="container-half">
          <div id="longestTrip" class="large-number"></div>
          <div class="large-number-label">miles on a single trip</div>
          <div class="large-number-fact">Your longest trip was on <strong><span id="longestTripDate"></span></strong></div>
          <div class="large-number-fact"><strong><span id="longestTripStart"></span></strong> to <strong><span id="longestTripEnd"></span></strong></div>
        </div>
        <div id="longestTripMap" class="map"></div>
        <div class="container-icon"></div>
      </div>
      <div class="container states-container" id="statesSection">
        <div class="container-whole">
          <div id="states" class="large-number"></div>
          <div class="large-number-label">US states driven</div>
          <div id="stateList" class="large-list"></div>
          <div class="container-icon"></div>
        </div>
      </div>
      <div class="container weekday-container" id="durationWeekday">
        <div class="container-half">
          <div id="durationWeekdayHours" class="large-number"></div>
          <div class="large-number-label">hours driving per weekday</div>
          <div class="large-number-fact"><strong><span id="durationWeekdayPercent"></span></strong> of your waking weekday hours</div>
        </div>
        <div class="container-half container-graph">
          <div id="durationGraph" class="graph"></div>
        </div>
        <div class="container-icon"></div>
      </div>
      <div class="container co2-container" id="co2Section">
        <div class="container-whole">
          <div id="co2" class="large-number"></div>
          <div class="large-number-label">lbs CO<sub>2</sub></div>
          <div class="large-number-fact"><strong><span id="co2Tree"></span></strong> large trees are required to offset this</div>
          <div class="container-icon"></div>
        </div>
      </div>
      <div class="container cost-container" id="costSection">
        <div class="container-half">
          <div id="cost" class="large-number"></div>
          <div class="large-number-label">fuel cost</div>
          <div class="large-number-fact"><strong><span id="costPercentIncome"></span></strong> of the US median household income</div>
        </div>
        <div class="container-half container-graph">
          <div id="costGraph" class="graph"></div>
        </div>
        <div class="container-icon"></div>
      </div>
      <div class="container mpg-container" id="mpgSection">
        <div class="container-half">
          <div id="mpg" class="large-number"></div>
          <div class="large-number-label">miles per gallon</div>
          <div class="large-number-fact">The average MPG of light-duty vehicles sold in 2015 was <strong><span id="">25.3</span></strong></div>
        </div>
        <div class="container-half container-graph">
          <div id="mpgGraph" class="graph"></div>
        </div>
        <div class="container-icon"></div>
      </div>

      <div class="learn-more">
        <a href="https://automatic.com" class="btn btn-blue btn-lg">Learn more about Automatic</a>
      </div>

      <div class="wrapper">
        <div class="share-container hidden">
          <div class="large-number-label hidden share-title">Share this Report</div>
          <input class="share-url" readonly>
          <a class="btn btn-lg btn-blue btn-share"><i class="fa fa-share"></i> Share this report</a>
          <div class="share-buttons hidden">
            <p>Anyone with this link can see this report.</p>
            <a href="" class="btn btn-blue btn-email" target="_blank"><i class="fa fa-envelope-o"></i> Email</a>
            <a href="" class="btn btn-blue btn-twitter" target="_blank"><i class="fa fa-twitter"></i> Twitter</a>
            <a href="" class="btn btn-blue btn-facebook" target="_blank"><i class="fa fa-facebook"></i> Facebook</a>
          </div>
        </div>
      </div>

      <a href="/#/labs" class="automatic-labs bottom dark" title="Back to Automatic Labs Home">Labs</a>
    </div>

    <div class="modal share-modal">
      <div class="modal-dialog">
        <div class="close">×</div>
        <div class="modal-content">
          <h3>Like sharing your data from Automatic?</h3>
          <p>Would you mind sharing some love for us as well? Do us a favor and leave a review.</p>
          <div class="review-buttons">
            <a href="https://bit.ly/AutomaticiOSApp" class="btn btn-lg btn-blue"><i class="fa fa-apple"></i> Apple</a>
            <a href="https://bit.ly/AutomaticAndroidApp" class="btn btn-lg btn-blue"><i class="fa fa-google"></i> Google Play</a>
            <a href="https://bit.ly/amzrevs" class="btn btn-lg btn-blue"><i class="fa fa-amazon"></i> Amazon</a>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-overlay"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/metrics-graphics/2.7.0/metricsgraphics.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox.js/v2.2.3/mapbox.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

    <script src="../common/js/polyline.js"></script>
    <script src="../common/js/main.js"></script>
    <script src="../common/js/maps.js"></script>

    <script>
      var data;
      var map;
      var currentYear = 2015;

      // animate anchor links
      $('.year-in-review-menu a').click(function(e) {
        e.preventDefault();

        $(document.body).animate({
          scrollTop: $(e.currentTarget.hash).offset().top
        }, 1000, 'easeInOutCubic');
      });

      $('.btn-share').click(function(e) {
        e.preventDefault();

        $('.btn-share').html(generateSpinner());
        saveShareData(data, function(e, shareUrlSlug) {
          if (e) {
            return alert(e);
          }

          var shareURL = window.location.origin + window.location.pathname + '?share=' + shareUrlSlug;
          showShareOptions(shareURL);
        });
      });


      $('.share-url').focus(function() {
        $(this).select();
      });


      $('.share-buttons .btn').click(function() {
        $('.share-modal, .modal-overlay').fadeIn();
      });


      $('#year').change(function() {
        getUserReport(parseInt(this.value, 10));
      });


      $('.modal .close').click(function() {
        $('.modal, .modal-overlay').fadeOut();
      });


      function showShareOptions(shareURL) {
        $('.share-url')
          .val(shareURL)
          .show()
          .select();
        $('.btn-share').hide();
        $('.share-title').slideDown();
        $('.share-buttons').slideDown();

        var emailShareURL = formatEmailShare('My ' + data.year + ' Driving Year in Review', 'This year I drove ' + formatNumber(data.totals.distance.toFixed()) + ' miles (' + calculateEarthCircumferencePercent(data.totals.distance) + '% of the circumference of the Earth).', shareURL);
        var twitterShareURL = formatTwitterShare('This year I drove ' + formatNumber(data.totals.distance.toFixed()) + ' miles (' + calculateEarthCircumferencePercent(data.totals.distance) + '% of the circumference of the Earth).', shareURL);
        var facebookShareURL = formatFacebookShare(shareURL);

        $('.btn-email').attr('href', emailShareURL);
        $('.btn-twitter').attr('href', twitterShareURL);
        $('.btn-facebook').attr('href', facebookShareURL);

        sessionStorage.setItem(data.year + 'ShareURL', shareURL);
      }


      function hideShareOptions() {
        $('.btn-share').html('<i class="fa fa-share"></i> Share this report').show();
        $('.share-url').hide();
        $('.share-title').hide();
        $('.share-buttons').hide();
      }


      function calculate(trips, user) {
        data.totals = convertTotals(sumTrips(trips));

        data.graphData = _.map(_.groupBy(trips, function(trip) {
          return moment(trip.started_at).format('YYYY-MM-DD');
        }), function(day, key) {
          return _.extend(convertTotals(sumTrips(day)), {date: key});
        });

        var monthlyData = _.map(_.groupBy(trips, function(trip) {
          return moment(trip.started_at).format('YYYY-MM-01');
        }), function(month, key) {
          return _.extend(convertTotals(sumTrips(month)), {date: key});
        });

        var stats = _.reduce(trips, function(memo, trip) {
          if (!memo.longest || memo.longest.distance_m < trip.distance_m) {
            memo.longest = trip;
          }
          if (trip.start_address && trip.start_address.state && trip.start_address.state !== 'Unknown') {
            var stateName = getStateName(trip.start_address.state);
            if (stateName) {
              memo.states[stateName] = true;
            }

          }
          if (trip.end_address && trip.end_address.state && trip.end_address.state !== 'Unknown') {
            var stateName = getStateName(trip.end_address.state);
            if (stateName) {
              memo.states[stateName] = true;
            }
          }

          return memo;
        }, {longest: null, states: {}});
        data.stats.states = _.keys(stats.states);
        data.stats.longest = sanitizeTrip(stats.longest);

        data.weekdayData = _.reject(data.graphData, function(day) {
          var dayOfWeek = moment(day.date, 'YYYY-MM-DD').day();
          return dayOfWeek === 0 || dayOfWeek === 6;
        });

        data.username = user ? user.first_name + ' ' + user.last_name : '';

        renderData();
      }

      function renderData() {
        if (queryParams.share) {
          $('.username').text(data.username + '\'s ' + data.year + ' Year in Review');
        } else {
          $('.username').text(data.username);
        }

        if (data.stats.firstTripStart) {
          $('.first-trip-date').text('First drove with Automatic on ' + moment(data.stats.firstTripStart).format('MM/DD/YYYY'));
        }

        if (!queryParams.share && !$('.year-control').is(':visible') && moment(data.stats.firstTripStart).year() < currentYear) {
          $('#year').html(_.range(currentYear, moment(data.stats.firstTripStart).year() - 1, -1).map(function(year) {
            return $('<option>').attr('value', year).text(year)
          }));
          $('.year-control').show();
        }

        var durationDays = moment.duration(data.totals.duration, 'hours').asDays();

        $('#distance').text(formatNumber(data.totals.distance.toFixed()));
        $('#distancePercentEarth').text(calculateEarthCircumferencePercent(data.totals.distance) + '%');
        $('#duration').text(durationDays.toFixed(1));
        var NUMBER_OF_DAYS_IN_MOST_YEARS = 365;
        $('#durationPercent').text((durationDays / NUMBER_OF_DAYS_IN_MOST_YEARS * 100).toFixed(1) + '%');
        $('#cost').text('$' + formatNumber(data.totals.fuel_cost_usd.toFixed(0)));
        var MEDIAN_US_HOUSEHOLD_INCOME = 51939;
        $('#costPercentIncome').text((data.totals.fuel_cost_usd / MEDIAN_US_HOUSEHOLD_INCOME * 100).toFixed(1) + '%');
        $('#mpg').text(data.totals.mpg.toFixed(1));
        $('#states').text(_.size(data.stats.states));
        $('#stateList').html(data.stats.states.sort().join(', '));

        if (data.weekdayData.length) {
          var durationWeekdayHoursPerDay = _.reduce(data.weekdayData, function(memo, day) { return memo += day.duration; }, 0) / data.weekdayData.length;
          var AVERAGE_HOURS_OF_WEEKDAY_SLEEP = 7.7;
          $('#durationWeekdayHours').html(durationWeekdayHoursPerDay.toFixed(1));
          $('#durationWeekdayPercent').text((durationWeekdayHoursPerDay / (24 - AVERAGE_HOURS_OF_WEEKDAY_SLEEP) * 100).toFixed(1) + '%');
        } else {
          $('#durationWeekday').hide();
        }

        $('#results').show();

        $('#longestTripDate').text(moment(data.stats.longest.started_at).format('MMMM D'));
        $('#longestTrip').text(metersToMiles(data.stats.longest.distance_m).toFixed());
        $('#longestTripStart').text(data.stats.longest.start_address ? data.stats.longest.start_address.display_name : '');
        $('#longestTripEnd').text(data.stats.longest.end_address ? data.stats.longest.end_address.display_name : '');

        var co2 = 19.64 * data.totals.fuel_volume;
        var tree = 50;

        $('#co2').text(formatNumber(co2.toFixed()));
        $('#co2Tree').text((co2 / tree).toFixed(1));


        if (map) {
          map.remove();
        }
        map = L.mapbox.map('longestTripMap', 'automatic.idonii25', {zoomControl: false});

        drawTripMap(data.stats.longest, map);

        drawGraphs();

        if (sessionStorage.getItem(data.year + 'ShareURL')) {
          showShareOptions(sessionStorage.getItem(data.year + 'ShareURL'));
        } else {
          hideShareOptions();
        }

        hideLoading();
      }


      function drawGraphs() {
        var graphData = data.graphData.map(function(day) {
          return _.extend(_.clone(day), {date: moment(day.date, 'YYYY-MM-DD').toDate()});
        });
        var minDate = moment().year(data.year).startOf('year').toDate();
        var maxDate = moment().year(data.year).endOf('year').toDate()

        $('#distanceGraph, #durationGraph, #costGraph, #mpgGraph').empty();
        MG.data_graphic({
          title: 'Miles Per Day in ' + data.year,
          decimals: 1,
          data: graphData,
          linked: true,
          full_width: true,
          full_height: true,
          bottom: 40,
          missing_is_zero: true,
          min_x: minDate,
          max_x: maxDate,
          xax_count: 12,
          xax_format: d3.time.format('%b'),
          y_rollover_format: function(d) {
            return d.distance.toFixed(1) + ' miles';
          },
          y_accessor: 'distance',
          target: '#distanceGraph',
          color: '#ffb85f'
        });

        MG.data_graphic({
          title: 'Hours Per Day in ' + data.year,
          decimals: 1,
          data: graphData,
          linked: true,
          full_width: true,
          height: 240,
          bottom: 40,
          missing_is_zero: true,
          min_x: minDate,
          max_x: maxDate,
          xax_count: 12,
          xax_format: d3.time.format('%b'),
          y_rollover_format: function(d) {
            return d.duration.toFixed(1) + ' hours';
          },
          y_accessor: 'duration',
          target: '#durationGraph',
          color: '#000000'
        });

        MG.data_graphic({
          title: 'Fuel Cost Per Day in ' + data.year,
          decimals: 2,
          data: graphData,
          linked: true,
          full_width: true,
          height: 240,
          bottom: 40,
          missing_is_zero: true,
          min_x: minDate,
          max_x: maxDate,
          xax_count: 12,
          xax_format: d3.time.format('%b'),
          y_rollover_format: function(d) {
            return '$' + d.fuel_cost_usd.toFixed(2);
          },
          y_accessor: 'fuel_cost_usd',
          yax_units: '$',
          target: '#costGraph',
          color: '#62511d'
        });

        MG.data_graphic({
          title: 'Daily Fuel Economy in ' + data.year,
          decimals: 1,
          data: _.reject(graphData, function(d) { return !d.mpg; }),
          linked: true,
          full_width: true,
          height: 240,
          bottom: 40,
          missing_is_zero: true,
          min_x: minDate,
          max_x: maxDate,
          xax_count: 12,
          xax_format: d3.time.format('%b'),
          y_rollover_format: function(d) {
            return d.mpg.toFixed(1) + ' mpg';
          },
          y_accessor: 'mpg',
          target: '#mpgGraph',
          color: '#98e236'
        });
      }

      function sumTrips(trips) {
        return trips.reduce(function(memo, trip) {
          memo.distance_m += trip.distance_m;
          memo.duration_s += trip.duration_s;
          memo.fuel_volume_l += trip.fuel_volume_l;
          memo.fuel_cost_usd += trip.fuel_cost_usd;
          return memo;
        }, {fuel_volume_l: 0, distance_m: 0, duration_s: 0, fuel_cost_usd: 0});
      }

      function convertTotals(totals) {
        var converted = {
          distance: metersToMiles(totals.distance_m),
          duration: moment.duration(totals.duration_s, 'seconds').asHours(),
          fuel_volume: litersToGallons(totals.fuel_volume_l),
          fuel_cost_usd: totals.fuel_cost_usd
        };

        converted.mpg = converted.distance / converted.fuel_volume;

        if (converted.mpg > 100) {
          converted.mpg = undefined;
        }

        return converted;
      }

      function getUserReport(year) {
        data = {
          stats: {},
          graphData: [],
          year: year
        };

        fetchAllTrips(function(results) {
          showLoading();
          var trips = _.filter(results, function(trip) {
            return moment(trip.started_at).year() === year;
          });

          if (!trips.length) {
            $('.alert').text('You have not taken any trips in ' + year + '.').show();
          }

          var firstTrip = _.last(results)
          data.stats.firstTripStart = (firstTrip) ? firstTrip.started_at : null;

          fetchUser(function(user) {
            calculate(trips, user);
          });
        }, function(progress) {
          $('.loading .progress').text(progress);
        });
      }

      function calculateEarthCircumferencePercent(distance) {
        var EARTH_CIRCUMFERENCE_MILES = 24901;
        return (distance / EARTH_CIRCUMFERENCE_MILES * 100).toFixed(1);
      }

      function sanitizeTrip(trip) {
        return _.pick(trip, 'path', 'date', 'start_address', 'end_address', 'start_location', 'end_location', 'started_at', 'distance_m');
      }

      /* On Page Load */
      formatForDemo();
      showLoginLink('year-in-review');

      var queryParams = getQueryParams(document.location.search);
      if (queryParams.share) {
        showLoading();

        getShareData(queryParams.share, function(e, result) {
          if (e) {
            return alert(e);
          }

          data = result;
          renderData();
          $('.learn-more').show();
          $('.share-intro-text').show();
        });
      } else {
        // get `currentYear` by default
        getUserReport(currentYear);
        if (!queryParams.demo) {
          $('.share-container').show();
          $('.intro-text').show();
        }
      }

      // Resize graphs on window resize
      $(window).resize(_.debounce(drawGraphs));
    </script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-33317148-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
