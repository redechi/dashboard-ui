<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Relocate Your Commute | Automatic Labs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://api.tiles.mapbox.com/mapbox.js/v2.1.9/mapbox.css" rel="stylesheet" />
    <link href="../common/css/style.css" rel="stylesheet" />
    <style>
      .map {
        width: 100%;
        height: 100%;
      }

      .toolbar {
        position: fixed;
        top: 10px;
        left: 70px;
        width : 380px;
        height: 30px;
        background: rgba(0, 0, 0, 0.5);
        color: #ffffff;
        padding: 10px 20px;
      }

      .toolbar h3 {
        margin: 0;
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <div class="loading">
      <div class="title">Loading...</div>
      <div class="text"></div>
    </div>
    <div id="relocatemap" class="map"></div>
    <div class="toolbar">
      <h3>Relocate your commute to:</h3>
      <select id="city">
        <option value="">Select a city</option>
        <option value="12.9667,77.5667">Bangalore</option>
        <option value="13.7563,100.5018">Bangkok</option>
        <option value="42.3601,-71.0589">Boston</option>
        <option value="42.3314,-83.0458">Detroit</option>
        <option value="25.2048,55.2708">Dubai</option>
        <option value="21.3000,-157.8167">Honolulu</option>
        <option value="29.7604,-95.3698">Houston</option>
        <option value="-6.1745,106.8227">Jakarta</option>
        <option value="-26.2044,28.0456">Johannesburg</option>
        <option value="6.4531,3.3958">Lagos</option>
        <option value="51.5072,-0.1275">London</option>
        <option value="34.0500,-118.2500">Los Angeles</option>
        <option value="19.4333,-99.1333">Mexico City</option>
        <option value="44.9778,-93.2650">Minneapolis</option>
        <option value="55.7500,37.6167">Moscow</option>
        <option value="37.3894,-122.0819">Mountain View</option>
        <option value="18.9750,72.8258">Mumbai</option>
        <option value="40.7127,-74.0059">New York</option>
        <option value="37.4292,-122.1381">Palo Alto</option>
        <option value="48.8567,2.3508">Paris</option>
        <option value="-22.9068,-43.1729">Rio de Janeiro</option>
        <option value="29.4167,-98.5000">San Antonio</option>
        <option value="37.7833,-122.4167">San Francisco</option>
        <option value="37.3382,-121.8863">San Jose</option>
        <option value="47.6097,-122.3331">Seattle</option>
        <option value="35.6833,139.6833">Tokyo</option>
        <option value="45.4375,12.3358">Venice</option>
        <option value="48.2000,16.3667">Vienna</option>
      </select>
    </div>

    <a href="/#labs" class="automatic-labs dark" title="Back to Automatic Labs Home">Labs</a>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox.js/v2.1.9/mapbox.js"></script>

    <script src="../common/js/main.js"></script>
    <script src="../common/js/maps.js"></script>

    <script>
      function weightedCenter(trips) {
        var points = _.reduce(trips, function(memo, trip) {
          if (trip.start_location.lat) {
            memo.lats.push(trip.start_location.lat);
            memo.lons.push(trip.start_location.lon);
          }
          if (trip.end_location.lat) {
            memo.lats.push(trip.end_location.lat);
            memo.lons.push(trip.end_location.lon);
          }

          return memo;
        }, {lats: [], lons: []});

        return [
           points.lats.sort()[Math.round(points.lats.length / 2)],
           points.lons.sort()[Math.round(points.lons.length / 2)]
        ];
      }


      function getOffset(a, b) {
        return [
          a[0] - b[0],
          a[1] - b[1]
        ];
      }


      function filterTrips(trips, center) {
        // remove all trips that start or end more than 50 miles from home
        var maxDistanceMi = 50;
        return _.reject(trips, function(trip) {
          var startDistanceFromCenter = calculateDistanceMi(trip.start_location.lat, trip.start_location.lon, center[0], center[1]);
          var endDistanceFromCenter = calculateDistanceMi(trip.end_location.lat, trip.end_location.lon, center[0], center[1]);
          return (startDistanceFromCenter > maxDistanceMi || endDistanceFromCenter > maxDistanceMi);
        });
      }


      fetchAllTrips(function(trips) {
        var mapId = 'relocatemap';
        var map = L.mapbox.map(mapId, 'automatic.lm09hkd2');
        var lineStyle = {color: '#b84329', opacity: 0.8, weight: 2};
        var bounds;
        var lines = [];
        var commuteTrips = filterTrips(trips, weightedCenter(trips));
        var center = weightedCenter(commuteTrips);

        drawTrips();
        map.fitBounds(bounds);

        $('#city').change(function() {
          var city = $(this).val();
          var cityLocation = city.split(',');

          if(!city) {
            return false;
          }

          clearMap();
          drawTrips(getOffset(cityLocation, center));
          map.panTo(cityLocation);
        });


        function clearMap() {
          lines.forEach(function(line) {
            map.removeLayer(line);
          });
          lines = [];
          bounds = undefined;
        }


        function drawTrips(offset) {
          commuteTrips.forEach(function(trip) {

            if (trip.path) {
              var points = L.GeoJSON.decodeLine(trip.path);

              if (offset) {
                points = _.map(points, function(point) {
                  return [
                    point[0] + offset[0],
                    point[1] + offset[1]
                  ];
                });
              }

              var line = L.polyline(points, lineStyle);

              line.addTo(map);

              lines.push(line);

              if (!bounds) {
                bounds = L.latLngBounds(line.getBounds());
              } else {
                bounds.extend(line.getBounds());
              }
            }
          });
        }
      });
    </script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-33317148-4', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
