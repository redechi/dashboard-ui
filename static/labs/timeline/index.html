<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Timeline | Automatic Labs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../common/css/style.css" rel="stylesheet" />
    <style>
      .wrapper {
        width: 700px;
        margin: 0 auto;
      }

      .day {
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        margin-top: 15px;
        background: #f6f6f6;
      }

      .day h2 {
        margin: 0;
      }

      .stat {
        display: inline-block;
        padding: 5px 10px 10px;
      }

      .map {
        height: 300px;
      }
    </style>

  </head>
  <body>
    <a class="btn-logout" href="/#/logout">Log out</a>
    <div class="wrapper">
      <div>
        <h1 class="labs-title">Timeline</h1>
        <div class="labs-tagline">By Automatic Labs</div>
      </div>
      <div class="alert alert-warning alert-demo">This is sample data from a demo account. <a class="login-link" href="#">Log in</a> to view your Automatic driving history.</div>
      <label>Vehicle:</label>
      <select id="vehicleSelect">
        <option>Select Vehicle</option>
      </select>
      <div id="days"></div>
    </div>

    <a href="/#/labs" class="automatic-labs" title="Back to Automatic Labs Home">Labs</a>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox.js/v2.2.3/mapbox.js"></script>

    <script type='text/template' id='dayTemplate'>
      <div class="day">
        <h2>{{moment(datetime).format('MMM, D, YYYY')}}</h2>
        <div class="stat">
          Trips: <b>{{items[0].title}}</b>
        </div>
        <div class="stat">
          Fuel Efficiency: <b>{{items[0].average_fuel_efficiency}}</b>
        </div>
        <div class="stat">
          Distance: <b>{{items[0].total_distance}}</b>
        </div>
        <div class="stat">
          Duration: <b>{{items[0].total_duration}}</b>
        </div>
        <div class="map">
          <img src="{{items[0].map_url}}"></div>
      </div>
    </script>

    <script src="../common/js/polyline.js"></script>
    <script src="../common/js/simplify.js"></script>
    <script src="../common/js/maps.js"></script>
    <script src="../common/js/main.js"></script>

    <script>
      _.templateSettings = {
        interpolate : /\{\{(.+?)\}\}/g
      };

      /* On Page Load */
      formatForDemo();
      showLoginLink('timeline');

      fetchVehicles(function(vehicles) {
        vehicles.forEach(function(vehicle) {
          $('#vehicleSelect').append($('<option>').attr('value', vehicle.id).text(vehicle.display_name));
        });
      });

      $('#vehicleSelect').change(function() {
        var accessToken = getAccessToken();
        var vehicleId = $('#vehicleSelect').val();

        $('#days').empty();

        $.ajax({
          url: 'https://view.automatic.com/vehicle/' + vehicleId + '/timeline/',
          headers: {
            Authorization: 'bearer ' + accessToken
          }
        })
        .done(function(results) {
          results.results.forEach(function(result) {
            var encodedPolylines = _.compact(_.pluck(result.items[0].trips, 'path'));
            result.items[0].map_url = getStaticMap(encodedPolylines, {width: 678});
            var dayTemplate = _.template($('#dayTemplate').html());

            $('#days').append($(dayTemplate(result)));
          });
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
          console.error(errorThrown);
          var selectedVehicle = $('#vehicleSelect option:selected').text();
          alert('Unable to fetch timeline for ' + selectedVehicle);
        });
      });


    </script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-33317148-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
