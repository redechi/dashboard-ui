<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Timeline | Automatic Labs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/css/bootstrap-datetimepicker-standalone.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />
    <link href="../common/css/style.css" rel="stylesheet" />
    <link href="css/timeline.css" rel="stylesheet" />
  </head>
  <body>
    <nav id="menu" class="slideout-menu">
      <ul class="vehicle-select">
      </ul>
      <ul>
        <li>
          <a href="#" class="add-photo">Add a Photo</a>
        </li>

      </ul>
    </nav>

    <main id="panel" class="panel">
      <div class="top-bar">
        <div class="top-bar-icon"></div>
        <div class="top-bar-title"></div>
      </div>
      <div id="timeline" class="timeline"></div>
      <div class="bottom-bar">
        <div class="bottom-bar-item activity active">Activity</div>
        <div class="bottom-bar-item health">Health</div>
        <div class="bottom-bar-item insights">Insights</div>
        <div class="bottom-bar-item glovebox">Glovebox</div>
      </div>
    </main>

    <div class="modal add-record-modal">
      <div class="modal-dialog">
        <div class="close">Ã—</div>
        <div class="modal-content">
          <h3>Add a photo to your timeline</h3>
          <p>Enter a photo URL, description and date.</p>
          <div class="form-group">
            <label>Photo URL</label>
            <input type="text" id="photoUrl" placeholder="http://myphoto.com" />
          </div>
          <div class="form-group">
            <label>Description</label>
            <input type="text" id="photoDescription" placeholder="My awesome picture" />
          </div>
          <div class="form-group">
            <label>Created Date</label>
            <input type="text" id="photoDate" />
          </div>
          <div class="form-group form-group-submit">
            <div class="btn btn-blue btn-save">Save</div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-overlay"></div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox.js/v2.2.3/mapbox.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/async/1.5.2/async.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/js/bootstrap-datetimepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/0.1.11/slideout.min.js"></script>

    <script type='text/template' id='dayTemplate'>
      <div class="day item">
        <div class="top-date">{{moment(datetime).format('MMM D, YYYY')}}</div>
        <h2>{{items[0].title}}</h2>
        <div class="trip-stats">
          <div class="stat">
            <div class="stat-label">Distance</div>
            <div class="stat-value">{{items[0].total_distance}}</div>
          </div>
          <div class="stat">
            <div class="stat-label">Duration</div>
            <div class="stat-value">{{items[0].total_duration}}</div>
          </div>
          <div class="stat">
            <div class="stat-label">Cost</div>
            <div class="stat-value">{{items[0].total_cost}}</div>
          </div>
        </div>
        <div class="map">
          <img src="{{items[0].map_url}}" class="map-image">
        </div>
      </div>
    </script>

    <script type='text/template' id='photoTemplate'>
      <div class="record item record-photo">
        <div class="top-date">{{moment(created_at).format('MMM D, YYYY')}}</div>
        <h2>{{data.photoDescription}}</h2>
        <img src="{{data.photoUrl}}" class="photo">
      </div>
    </script>

    <script src="../common/js/polyline.js"></script>
    <script src="../common/js/simplify.js"></script>
    <script src="../common/js/maps.js"></script>
    <script src="../common/js/main.js"></script>

    <script>
      _.templateSettings = {
        interpolate : /\{\{(.+?)\}\}/g
      };

      var viewserverAPI = 'https://view.automatic.com';
      var recordsAPI = 'https://records-service-prod.herokuapp.com';
      var accessToken = getAccessToken();

      var dayTemplate = _.template($('#dayTemplate').html());
      var photoTemplate = _.template($('#photoTemplate').html());
      var vehicles;
      var selectedVehicleId;

      /* On Page Load */
      $('#photoDate').datetimepicker({
        icons: {
          time: 'fa fa-clock-o',
          date: 'fa fa-calendar',
          up: 'fa fa-arrow-up',
          down: 'fa fa-arrow-down',
          next: 'fa fa-arrow-right',
          previous: 'fa fa-arrow-left'
        }
      });

      var slideout = new Slideout({
        panel: document.getElementById('panel'),
        menu: document.getElementById('menu'),
        padding: 256,
        tolerance: 70
      });

      fetchVehicles(function(results) {
        vehicles = results;
        vehicles.forEach(function(vehicle) {
          $('.vehicle-select').append($('<li>').append($('<a>').attr('href', '#').data('vehicleId', vehicle.id).text(vehicle.display_name)));
        });

        fetchItems(_.first(vehicles).id);
      });

      $('.top-bar-icon').click(function() {
        slideout.toggle();
      });

      $('.slideout-menu').click(function() {
        slideout.close();
      });

      $('.vehicle-select').on('click', 'li a', function(e) {
        e.preventDefault();
        var vehicleId = $(e.target).data('vehicleId');
        fetchItems(vehicleId);
      });

      $('.add-photo').click(function() {
        $('.add-record-modal, .modal-overlay').fadeIn();
      });

      $('.modal .close').click(function() {
        $('.modal, .modal-overlay').fadeOut();
      });

      $('.btn-save').click(function(e) {
        e.preventDefault();

        var photoUrl = $('#photoUrl').val();
        var photoDescription = $('#photoDescription').val();
        var photoDate = $('#photoDate').data('DateTimePicker').date();

        if(!photoUrl) {
          return alert('Please enter a photo URL');
        }

        if(!photoDate) {
          return alert('Please enter a date and time for this photo');
        }

        var record = {
          vehicle_id: selectedVehicleId,
          created_at: photoDate.toISOString(),
          data: {
            photoDescription: photoDescription,
            photoUrl: photoUrl,
            type: 'photo'
          }
        };

        $.ajax({
          method: 'POST',
          url: recordsAPI + '/timeline_event',
          headers: {
            Authorization: 'bearer ' + accessToken
          },
          data: record,
          success: function(response) {
            $('.modal, .modal-overlay').fadeOut();
            fetchItems(selectedVehicleId);
          },
          error: function(jqXHR, textStatus, errorThrown) {
            console.error(errorThrown);
            $('.modal, .modal-overlay').fadeOut();
          }
        });
      });

      function fetchItems(vehicleId) {
        selectedVehicleId = vehicleId;
        var vehicle = _.findWhere(vehicles, {id: vehicleId});

        setTitle(vehicle.display_name);

        $('#timeline').empty();

        async.parallel([
          getDays,
          getRecords
        ], function(err, results) {
          if(err) {
            console.log(err);
            return alert('Unable to fetch results');
          }

          renderTimeline(_.flatten(results, true));
        });

        function getDays(cb) {
          $.ajax({
            url: viewserverAPI + '/vehicle/' + vehicleId + '/timeline/',
            headers: {
              Authorization: 'bearer ' + accessToken
            }
          })
          .done(function(results) {
            var days = results.results.map(function(item) {
              return item;
            });
            cb(null, days);
          })
          .fail(function(jqXHR, textStatus, errorThrown) {
            console.error(errorThrown);
            cb(errorThrown);
          });
        }

        function getRecords(cb) {
          $.ajax({
            url: recordsAPI + '/timeline_event',
            headers: {
              Authorization: 'bearer ' + accessToken
            }
          })
          .done(function(results) {
            var records = _.where(results.results, { vehicle_id: vehicleId }).map(function(record) {
              record.type = 'record:record';
              record.datetime = record.created_at;
              return record;
            });
            cb(null, records);
          })
          .fail(function(jqXHR, textStatus, errorThrown) {
            console.error(errorThrown);
            cb(errorThrown);
          });
        }
      }

      function renderTimeline(items) {
        var divs = _.compact(sortItemsByDate(items).map(function(item) {
          if(item.type === 'record:day-group') {
            return renderDay(item);
          } else if(item.type === 'record:record') {
            return renderRecord(item);
          }
        }));

        if(!divs.length) {
          return $('#timeline').append($('<div class="item nothing">Nothing found for this vehicle</div>'));
        }

        $('#timeline').append(divs);
      }

      function renderDay(day) {
        var encodedPolylines = _.compact(_.pluck(day.items[0].trips, 'path'));
        day.items[0].map_url = getStaticMap(encodedPolylines, {width: 678});
        console.log(day);
        return $(dayTemplate(day));
      }

      function renderRecord(record) {
        if(!record.data || !record.data.type) {
          return null;
        }

        if(record.data.type === 'photo') {
          console.log(record);
          return $(photoTemplate(record));
        }
      }

      function sortItemsByDate(items) {
        return _.sortBy(items, function(item) {
          return -moment(item.datetime).valueOf();
        });
      }

      function setTitle(title) {
        $('.top-bar-title').text(title);
      }
    </script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-33317148-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
