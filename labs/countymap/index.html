<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>County Driving Map | Automatic Labs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="../common/css/style.css" rel="stylesheet" />
    <style>
      .wrapper {
        width: 700px;
        margin: 0 auto;
      }

      .map-info {
        position: absolute;
        top: 10px;
        left: 10px;
        padding: 5px 8px;
      }

      .map-info h1 {
        margin: 0;
      }

      .map-info h3 {
        margin: 0;
      }

      .state {
        float: left;
        width: 175px;
        overflow: auto;
      }

      .state:nth-child(4n+1) {
        clear: both;
      }

      .map {
        width: 100%;
      }

      .county {
        fill: none;
        stroke: #CCC;
      }

      .county.visited {
        fill: rgb(207, 81, 50);
        stroke: rgb(102, 37, 20);
        opacity: 0.8;
      }

      .graph-tooltip {
         position: absolute;
         text-align: center;
         min-width: 150px;
         height: 20px;
         padding: 2px;
         font-size: 16px;
         background: #ddd;
         border: 1px solid #aaa;
         border-radius: 8px;
         pointer-events: none;
      }

      .graph-tooltip.visited {
        color: #fff;
        background: rgb(207, 81, 50);
        border-color: rgb(102, 37, 20);
      }

      .loading {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="loading">
      <div class="title">Loading...</div>
      <div class="text"></div>
    </div>
    <div class="map-info">
      <h1>County Driving Map</h1>
      <h3>Collect them all!</h3>
    </div>
    <div id="countymap" class="map"></div>
    <div class="wrapper">
      <div id="results"></div>
    </div>
    <a href="/#labs" class="automatic-labs" title="Back to Automatic Labs Home">Labs</a>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>

    <script src="../common/js/main.js"></script>

    <script>
      var states = {};
      var counties = {};
      var idx = 0;
      var paths;
      var container;
      var countyData;
      var d3Path;
      var drag;
      var graphTooltip;
      var q = queue();

      function renderCounties() {
        $('#results').empty();

        var stateContainer = $('<div>').addClass('states');

        _.keys(states).sort().forEach(function(state) {
          var container = $('<div>').addClass('state');
          $('<h3>').text(state).appendTo(container);

          $(container).append(_.keys(states[state]).sort().map(function(county) {
            return $('<div>').text(county);
          }));

          container.appendTo(stateContainer);
        });

        stateContainer.appendTo('#results');

        updateMap();
      }

      function summarize() {
        var totalCounties = 3232;
        var totalStates = 50;
        var stateCount = _.size(states);
        var countyCount = _.reduce(states, function(memo, counties) {
          return memo += _.size(counties);
        }, 0);
        $('<small>').html('<sup>*</sup> or county equivalents').prependTo('#results');
        $('<p>').html('You have driven to ' + countyCount + ' of ' + totalCounties + ' US Counties<sup>*</sup> and ' + stateCount + ' of ' + totalStates + ' US States').prependTo('#results');
      }


      function drawMap() {
        var width = $(window).width(),
            height = Math.max($(window).height() / 2, 500),
            center = [width / 2, height / 2],
            marginLeft = (width - 960) / 2;

        graphTooltip = d3.select('body').append('div')
        .attr('class', 'graph-tooltip')
        .style('opacity', 0);

        var zoom = d3.behavior.zoom()
        .scaleExtent([1, 40])
        .on('zoom', zoomed);

        drag = d3.behavior.drag()
        .origin(function(d) { return d; })
        .on('dragstart', dragstarted)
        .on('drag', dragged)
        .on('dragend', dragended);

        d3Path = d3.geo.path();

        var svg = d3.select('#countymap').append('svg')
        .attr('width', width)
        .attr('height', height)
        .call(zoom);

        container = svg.append('g');

        queue()
        .defer(d3.json, 'counties.json')
        .await(function(error, us) {
          countyData = us;

          container.attr('class', 'counties')
          .style('stroke-width', 0.5)
          .attr('transform', 'translate(' + marginLeft + ',0)')
          .selectAll('path')
          .data(topojson.feature(countyData, countyData.objects.counties).features)
          .enter().append('path')
          .attr('class', 'county')
          .attr('data-county', function(d) {return d.id; })
          .attr('d', d3Path)
          .call(drag)
          .on('mouseover', function(d) {
            var county = counties[d.id];

            if(county) {
              graphTooltip.attr('class', 'graph-tooltip');

              d3.select(this).transition().duration(100).style('opacity', 1);
              graphTooltip.transition().duration(100)
              .style('opacity', 1);

              graphTooltip.text(county.county + ', ' + county.state)
                .style('left', (d3.event.pageX) + 'px')
                .style('top', (d3.event.pageY -30) + 'px');
            }
          })
          .on('mouseout', function() {
            d3.select(this)
            .transition().duration(300)
            .style('opacity', 0.8);
            graphTooltip.transition().duration(300)
            .style('opacity', 0);
          });

          // Zoom Buttons
          var g = svg.selectAll('.button')
            .data(['zoom_in', 'zoom_out'])
            .enter()
            .append('g');

          g.append('rect')
            .attr({y: height - 30, width: 40, height: 20, class: 'button', stroke: '#aaa', fill: '#fafafa'})
            .attr('x', function(d,i){return 20 + 50*i})
            .style({cursor: 'pointer'})
            .attr('id', function(d){return d});

          g.append('text')
            .attr({y: height - 15, width: 40, height: 20, class: 'button', fill: '#333'})
            .attr('x', function(d,i){return 36 + 50*i})
            .style({cursor: 'pointer'})
            .text(function(d,i){ return i ? '-' : '+'})
            .attr('id', function(d){return d});


          d3.selectAll('.button').on('click', function(){
            d3.event.preventDefault();

            var scale = zoom.scale(),
                extent = zoom.scaleExtent(),
                translate = zoom.translate(),
                x = translate[0], y = translate[1],
                factor = (this.id === 'zoom_in') ? 1.2 : 1/1.2,
                target_scale = scale * factor;

            // If the factor is too much, scale it down to reach the extent exactly
            var clamped_target_scale = Math.max(extent[0], Math.min(extent[1], target_scale));
            if (clamped_target_scale != target_scale){
              target_scale = clamped_target_scale;
              factor = target_scale / scale;
            }

            // Center each vector, stretch, then put back
            x = (x - center[0]) * factor + center[0];
            y = (y - center[1]) * factor + center[1];

            // Transition to the new view over 350ms
            d3.transition().duration(350).tween('zoom', function () {
              var interpolate_scale = d3.interpolate(scale, target_scale),
                  interpolate_trans = d3.interpolate(translate, [x,y]);
              return function (t) {
                zoom.scale(interpolate_scale(t))
                    .translate(interpolate_trans(t));
                zoomed();
              };
            });
          });

          updateMap();
        });

        function dottype(d) {
          d.x = +d.x;
          d.y = +d.y;
          return d;
        }

        function zoomed() {
          container.style('stroke-width', Math.min(1.5 / zoom.scale(), 0.5) + 'px');
          container.attr('transform', 'translate(' + zoom.translate() + ')scale(' + zoom.scale() + ')');
        }

        function dragstarted(d) {
          d3.event.sourceEvent.stopPropagation();
          d3.select(this).classed('dragging', true);
        }

        function dragged(d) {
          d3.select(this).attr('cx', d.x = d3.event.x).attr('cy', d.y = d3.event.y);
        }

        function dragended(d) {
          d3.select(this).classed('dragging', false);
        }
      }


      function updateMap() {
        _.each(states, function(state) {
          _.each(state, function(id) {
            $('[data-county="' + id + '"]').attr('class', 'visited county');
          });
        });
      }


      function groupPaths() {
        var pathGroups = [];

        (function getGroup() {
          var length = 0;
          var pathGroup = [];
          var maxLength = 10000;

          while(length < maxLength) {
            var path = paths.pop();
            if (path) {
              length += path.length;
              pathGroup.push(path);
            } else {
              length = maxLength;
            }
          }
          pathGroups.push(pathGroup);

          if(paths.length) {
            getGroup();
          }
        })()

        return pathGroups;
      }


      function fetchPaths(pathGroup) {
        q.defer(function(cb) {
          $.ajax({
            url: 'https://1vcb2sxf7h.execute-api.us-east-1.amazonaws.com/prod/getCounty',
            method: 'POST',
            data: JSON.stringify(pathGroup),
            contentType: 'application/json'
          }).done(function(data) {
            _.each(data, function(county) {
              if(!states[county.state]) {
                states[county.state] = {};
              }
              var id = parseInt(county.id, 10).toString();
              states[county.state][county.county] = id;
              counties[id] = county;
            });

            renderCounties();
          }).fail(function(jqXHR, textStatus, error) {
            console.error(error);
          }).always(function() {
            $('.loading .title').text('Processing trips ' + (idx + 1) + '-' + (idx + pathGroup.length));
            $('.loading .text').empty();
            idx += pathGroup.length;
            cb();
          });
        });
      }


      function getCounties() {
        showLoading();

        var pathGroups = groupPaths();

        pathGroups.forEach(fetchPaths);

        q.await(function(e) {
          console.log(e);
          summarize();
          hideLoading();
        });
      }


      fetchAllTrips(function(trips) {
        if(!trips || !trips.length) {
          return alert('You have no trips');
        }

        drawMap();

        paths = _.compact(_.pluck(trips, 'path'));

        getCounties();
      });
    </script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-33317148-4', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>
